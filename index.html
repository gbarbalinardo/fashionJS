<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>fashion.js</title>


       <link rel="stylesheet" type="text/css" href="css/style.css" />
</head>
<body>
<div class="img_container" id="imgs1">

            <img id="1" src="img/0.jpg"> 
            <img id="2" src="img/2.jpg">
            <img id="3" src="img/3.jpg">
            <img id="4" src="img/4.jpg">
            <img id="5" src="img/5.jpg">
            <img id="6" src="img/6.jpg">
            <img id="7" src="img/7.jpg">
            <img id="8" src="img/8.jpg">
            <img id="9" src="img/9.jpg">
            <img id="10" src="img/10.jpg">
            <img id="11" src="img/11.jpg"> 
            <img id="12" src="img/12.jpg">
            <img id="13" src="img/13.jpg">
            <img id="14" src="img/14.jpg">
            <img id="15" src="img/15.jpg">
            <img id="16" src="img/16.jpg">
            <img id="17" src="img/17.jpg">
            <img id="18" src="img/18.jpg">

	    </div>
  <script>

var imgs = [];
window.onload = function(){
    imgs = importPics();
    console.log(imgs);
    var div = document.getElementById("imgs1");
    div.parentNode.removeChild(div);
    imgs = combine(imgs);

    show(imgs);

};


function combine(images){
    for(k=images.length-1;k>0;k--){
        ca = 0;
        //Look for the best
        for (var i=k-1; i>=0; i--){
            aRight = Math.pow(images[i].r,2)/images[k].r *images[i].a/images[i].r;
            if (Math.pow(images[k].a-aRight,2)<Math.pow(images[k].a-ca,2)){
              ca = aRight;
              ci = i;
              isRight = true;
            }  
            aDown = images[k].r *images[i].a/images[i].r;
            if (Math.pow(images[k].a-aDown,2)<Math.pow(images[k].a-ca,2)){
              ca = aDown;
              ci = i;
              isRight = false;
            }  
            //console.log("i:"+i+", aright:"+aRight+", adown:"+aDown );
        }
        //print the chosen area
        //console.log ("closest a: " + ca + ", closest i: "+ ci +" isRight :"+isRight);
        rand = Math.random();
            
        if(isRight){
            zoom = Math.sqrt(images[ci].a*images[ci].r/(images[k].a*images[k].r));
            z1 = Math.sqrt(zoom);
            z2 = 1/Math.sqrt(zoom);


            images[k].a = images[k].a*Math.pow(z1,2);
            resizeChildren(images[k].div, z1);

            images[ci].a = images[ci].a*Math.pow(z2,2);
            resizeChildren(images[ci].div, z2);
            //change later        
            images[ci].div.style.display = "inline-block";
            images[k].div.style.display = "inline-block";
            console.log(rand);
            if(rand>.5) images[k].div.style.position = "absolute";
            else images[ci].div.style.position = "absolute";
            //white-space: nowrap
            //update the combined div
            ratio = images[ci].r*images[k].r/(images[ci].r+images[k].r);
            priority = (images[ci].p+images[k].p)/2.0;
        }
        else{
            //Update the placed div
            zoom = Math.sqrt(images[ci].a*images[k].r/(images[k].a*images[ci].r));

            z1 = Math.sqrt(zoom);
            z2 = 1/Math.sqrt(zoom);


            images[k].a = images[k].a*Math.pow(z1,2);
            resizeChildren(images[k].div, z1);

            images[ci].a = images[ci].a*Math.pow(z2,2);
            resizeChildren(images[ci].div, z2);


            //update the combined div
            ratio = images[ci].r+images[k].r;
            priority = (images[ci].p+images[k].p)/2.0;   
        }
        divBox = document.createElement("div");
        var div1 = images[ci].div.cloneNode(true);
        var div2 = images[k].div.cloneNode(true);
        if (rand>.5){
            divBox.appendChild(div1);
            divBox.appendChild(div2);
        }
        else{
            divBox.appendChild(div2);
            divBox.appendChild(div1);
        }

        area = images[k].a+images[ci].a;
        imgpush = { r : ratio, div: divBox, p: priority, a: area};
     
        divBox.style.width = Math.round(Math.sqrt(area/ratio))+"px";
        //console.log(Math.sqrt(area/ratio));
        divBox.style.height = Math.round(Math.sqrt(area*ratio))+"px";
        //changelater
        divBox.style.display = "block";
        divBox.style.float = "left";
        for (var i=k-1;i>=0; i--){
            if (images[i].a>imgpush.a){
                break;
            }
        }
        images.splice(i+1, 0, imgpush);
        images.splice(ci+1, 1);//TODO: Check why there is +1
        images.splice(k,1);
    }
    return images;
}


function resizeChildren(divv, zoom){
    divs = divv.getElementsByTagName("*");
    //if(divs.length==0){
        //console.log(divv);
        var h = parseFloat(divv.style.height,10);
        //console.log(divv.style.height);
        
        var w = parseFloat(divv.style.width,10);
        //console.log(divv.style.width);
        if(h!=0){
            divv.style.height = Math.round(h*zoom)+"px";
            divv.style.width = Math.round(w*zoom)+"px";
        }
    //}
    for (j = 0; j<divs.length ; j++) {
        hh = parseFloat(divs[j].style.height,10);
        ww = parseFloat(divs[j].style.width,10);
        if(hh!=0){
            divs[j].style.height = Math.round(hh*zoom)+"px";
            divs[j].style.width = Math.round(ww*zoom)+"px";
        }
    }
    return h*w;
}

function importPics(){
    var pictures = [];
    var images = [];
    pictures = document.getElementById("imgs1").getElementsByTagName('img');
    var totalArea = 0;
    for(i=0; i<pictures.length; i++) {
        width = pictures[i].clientWidth;
        ratio = pictures[i].clientHeight/width;
        priority = parseFloat(pictures[i].id);
        //box into a div
        var divBox = document.createElement("div");
        divBox.className = "imgdiv";
        divBox.style.backgroundImage = "url('"+pictures[i].src+"')";
        divBox.innerHTML = priority;
        divBox.style.backgroundRepeat = "no-repeat";
        divBox.style.backgroundSize = "100%";
        divBox.style.display = "block";
        divBox.style.float = "left";
        var imgpush = { w: width, r : ratio, div: divBox, p: priority ,a: width*width*ratio};    
        images.push(imgpush);
        totalArea += area(priority);
    }
    for(i=0; i<images.length; i++) {
        images[i].a = area(images[i].p)/totalArea*1000000;
        images[i].div.style.width = Math.round(Math.sqrt(images[i].a / images[i].r))+"px";
        images[i].div.style.height = Math.round(Math.sqrt(images[i].a * images[i].r))+"px";
    }
    return images;
}

function show(images){
    div = document.createElement("div");
    for(i=0; i<images.length; i++){
        div.appendChild(images[i].div);
    }
    document.body.appendChild(div);
}

function area(priority){
    return 1/priority;
}
</script>


</body>
</html>
